<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>foio</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        /* Общие настройки - Material Minimal */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body, html { margin: 0; padding: 0; height: 100%; font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: #f5f5f5; color: #333; overflow: hidden; }
        
        /* Экран регистрации */
        #reg-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1000; background: #fff; display: none; }
        .reg-container { width: 100%; max-width: 300px; margin: 100px auto; text-align: center; padding: 20px; }
        
        /* Плиточные элементы */
        input[type="text"] { width: 100%; border: 2px solid #00A3E0; padding: 12px; font-size: 16px; outline: none; background: #fff; margin-bottom: 10px; }
        button { width: 100%; background: #00A3E0; color: #fff; border: none; padding: 14px; font-size: 14px; font-weight: bold; cursor: pointer; text-transform: uppercase; letter-spacing: 1px; }
        button:active { background: #008fbc; }

        /* Шапка */
        #header { height: 56px; line-height: 56px; background: #00A3E0; color: #fff; font-size: 20px; font-weight: 500; padding: 0 20px; position: absolute; top: 0; width: 100%; box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 100; }

        /* Область чата */
        #chat-container { position: absolute; top: 56px; bottom: 60px; width: 100%; overflow-y: auto; padding: 10px 0; -webkit-overflow-scrolling: touch; background: #fff; }
        .msg { padding: 12px 16px; border-bottom: 1px solid #f0f0f0; display: table; width: 100%; }
        
        /* Аватарка */
        .avatar { width: 42px; height: 42px; line-height: 42px; text-align: center; color: #fff; font-size: 18px; font-weight: bold; display: table-cell; vertical-align: middle; text-transform: uppercase; }
        
        /* Текст сообщения */
        .msg-body { display: table-cell; vertical-align: top; padding-left: 15px; }
        .nick { font-weight: bold; font-size: 13px; color: #00A3E0; margin-bottom: 2px; }
        .text { font-size: 15px; line-height: 1.4; color: #222; word-break: break-word; }

        /* Нижняя панель ввода */
        #footer { position: absolute; bottom: 0; width: 100%; height: 60px; background: #fff; border-top: 1px solid #ddd; display: table; }
        #input-wrap { display: table-cell; width: 80%; vertical-align: middle; padding-left: 10px; }
        #msg-input { width: 100%; border: none; padding: 10px; font-size: 16px; outline: none; }
        #btn-wrap { display: table-cell; width: 20%; vertical-align: middle; padding: 0 10px; }
        #send-btn { width: 100%; padding: 10px 5px; font-size: 12px; }

        /* Цвета аватарок (Material Colors) */
        .av0 { background: #F44336; } .av1 { background: #FFC107; } .av2 { background: #4CAF50; }
        .av3 { background: #03A9F4; } .av4 { background: #9E9E9E; } .av5 { background: #795548; }
        .av6 { background: #9C27B0; } .av7 { background: #8BC34A; }
    </style>
</head>
<body>
<div id="reg-screen">
        <div class="reg-container">
            <h1 style="color:#00A3E0; font-size: 48px; margin-bottom: 10px;">foio</h1>
            <p style="margin-bottom: 20px; color: #666;">Enter nickname (latin/numbers)</p>
            <input type="text" id="nick-input" placeholder="Nickname..." maxlength="15">
            <button id="join-btn">Start</button>
        </div>
    </div>

    <div id="main-screen">
        <div id="header">foio</div>
        <div id="chat-container"></div>
        <div id="footer">
            <div id="input-wrap">
                <input type="text" id="msg-input" placeholder="Message...">
            </div>
            <div id="btn-wrap">
                <button id="send-btn">Send</button>
            </div>
        </div>
    </div>

    <script>
        var firebaseConfig = {
            apiKey: "AIzaSyCAUKnh1wsWSU1gwGxyXetZ5jvFB3YeUOo",
            databaseURL: "https://foio-forum-default-rtdb.firebaseio.com",
            projectId: "foio-forum",
        };
        firebase.initializeApp(firebaseConfig);
        var db = firebase.database();

        var myNick = localStorage.getItem('foio_nick');
        var colors = ['av0', 'av1', 'av2', 'av3', 'av4', 'av5', 'av6', 'av7'];

        if (!myNick) {
            document.getElementById('reg-screen').style.display = 'block';
        }

        function getAvColor(nick) {
            var sum = 0;
            for (var i = 0; i < nick.length; i++) sum += nick.charCodeAt(i);
            return colors[sum % colors.length];
        }

        document.getElementById('join-btn').onclick = function() {
            var nick = document.getElementById('nick-input').value.replace(/[^a-zA-Z0-9]/g, "").toLowerCase();
            
            if (nick.length < 3) { 
                alert("Min 3 symbols!"); 
                return; 
            }

            // Прямая проверка существования ника вместо сложной транзакции
            // Это надежнее для старых браузеров
            var userRef = db.ref('users/' + nick);
            
            userRef.once('value', function(snapshot) {
                if (snapshot.exists()) {
                    alert("This nickname is ALREADY TAKEN!");
                } else {
                    // Если ника нет, создаем его
                    userRef.set({ reg: true }, function(error) {
                        if (error) {
                            // Если вылезет эта ошибка - значит ПРАВИЛА в Firebase не настроены!
                            alert("Database Error: Check your Firebase Rules!");
                        } else {
                            localStorage.setItem('foio_nick', nick);
                            location.reload();
                        }
                    });
                }
            });
        };

        document.getElementById('send-btn').onclick = sendMessage;
        function sendMessage() {
            var text = document.getElementById('msg-input').value;
            if (!text.trim() || !myNick) return;

            db.ref('messages').push({
                nick: myNick,
                text: text,
                time: Date.now()
            });
            document.getElementById('msg-input').value = "";
        }

        db.ref('messages').limitToLast(50).on('child_added', function(snap) {
            var m = snap.val();
            var chat = document.getElementById('chat-container');
            var msgDiv = document.createElement('div');
            msgDiv.className = 'msg';
            
            var avClass = getAvColor(m.nick);
            msgDiv.innerHTML = '<div class="avatar ' + avClass + '">' + m.nick.charAt(0) + '</div>' +
                               '<div class="msg-body">' +
                               '<div class="nick">' + m.nick + '</div>' +
                               '<div class="text">' + m.text + '</div>' +
                               '</div>';
            
            chat.appendChild(msgDiv);
            chat.scrollTop = chat.scrollHeight;
        });

        document.getElementById('msg-input').onkeypress = function(e) {
            if (e.keyCode == 13) sendMessage();
        };
    </script>
</body>
</html>